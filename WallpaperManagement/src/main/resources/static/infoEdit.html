<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改密码</title>
    <link type="text/css" href="css/personalCenter.css" rel="stylesheet"/>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/2.1.3/jquery.min.js"></script>
    <script src="js/global.js"></script>
    <script src="js/imageutil.js"></script>
    <script>
        $(function () {
            // 获取所有的菜单项
            const menuItems = document.querySelectorAll('.leftdiv .menu a');
            // 获取当前页面的URL
            const currentPage = window.location.pathname;
            // 遍历所有的菜单项
            menuItems.forEach(item => {
                // 获取菜单项的跳转链接
                const link = item.getAttribute("href");
                // 如果链接与当前页面匹配，则为该菜单项添加 'active' 类
                if ("/" + link === currentPage) {
                    item.classList.add('active');
                }
            });

            $.ajax({
                url: "getCurrentInfo.action",
                type: "post",
                dataType: "json",
                success: function (user) {
                    $("#userName").val(user.userName);
                    $("#nickname").val(user.nickname);
                    $("#mail").val(user.mail);
                    $("#phone").val(user.phone);
                    $("#birthday").val(user.birthday);
                    $("#recordDay").val(user.recordDay);
                    // 以下为隐藏域参数
                    $("#id").val(user.id);
                    $("#fileName").val(user.fileName);
                    $("#preview").attr("src", "avatar/" + user.fileName + "?t=" + new Date().toString());
                    $("#headImg").attr("src", "avatar/" + user.fileName + "?t=" + new Date().toString());
                }
            });

            //提交按钮
            $("#submit").click(function () {
                var nickname = $("#nickname").val();
                var flag = true;
                if (nickname == "") {
                    alert("昵称不能为空！");
                    flag = false;
                }

                if (flag) {
                    //满足条件，提交数据即可，此时可以利用表单携带参数
                    //先判断文件域是否为空
                    if ($("#picture").val() != "") {
                        var formData = new FormData($("#form")[0]);
                        $.ajax({
                            url: "fileUpload.action",
                            type: "post",
                            data: formData,
                            async: false,
                            processData: false,  //是否把参数变成字符串，默认为true，代表变成
                            contentType: false,   //相当于指定 enctype="multipart/form-data"，默认为true application/x-www-form-urlencoded
                            success: function (data) {
                                $("#fileName").val(data);
                            }
                        });
                    }

                    //在修改其他普通文本数据
                    $.ajax({
                        url: "updateCurrentUser.action",
                        type: "post",
                        data: $("#form").serialize(),  //利用表单携带参数，但不提交请求
                        success: function (data) {
                            if (data == 1) {
                                alert("修改成功！");
                                window.location.reload(); //让最外层刷新，目的是让头像刷新显示
                            } else if (data == 0) {
                                alert("修改失败！");
                            }
                        }
                    });
                }
            });
        })
    </script>
</head>
<body>
<div class="mainBag">
    <div class="background">
        <img src="images/5.png">
    </div>
</div>
<div class="leftdiv">
    <div class="profile">
        <img id="headImg">
    </div>
    <div class="menu">
        <ul>
            <li><a href="info.html">个人信息</a></li>
            <li><a href="infoEdit.html">修改信息</a></li>
            <li><a href="passwordEdit.html">修改密码</a></li>
        </ul>
    </div>
</div>
<div class="rightdiv">
    <form id="form">
        <input type="hidden" name="id" id="id"/><!--隐藏admin id 做修改用途-->
        <input type="hidden" name="fileName" id="fileName"/><!--隐藏头像图片名称-->
        <div class="group">
            <div class="label">
                <label>账号：</label>
            </div>
            <div class="field">
                <input type="text" class="mess" readonly id="userName" name="userName" style="cursor: not-allowed"/>
            </div>
        </div>
        <div class="group">
            <div class="label">
                <label>头像：</label>
            </div>
            <div class="field" style="display: flex; align-content: center;">
                <input type="file" id="picture" name="picture" onchange="setImagePreview(this, localImag, preview, '50px','50px')"/>
                <div id="localImag" style="margin-left: 24px"></div>
                <img id="preview" style="margin-left: 10px; width: 50px; height: 50px;"/>
            </div>
        </div>
        <div class="group">
            <div class="label">
                <label>昵称：</label>
            </div>
            <div class="field">
                <input type="text" class="mess" id="nickname" name="nickname"/>
            </div>
        </div>
        <div class="group">
            <div class="label">
                <label>邮箱：</label>
            </div>
            <div class="field">
                <input type="text" class="mess" id="mail" name="mail"/>
            </div>
        </div>
        <div class="group">
            <div class="label">
                <label>手机：</label>
            </div>
            <div class="field">
                <input type="text" class="mess" id="phone" name="phone"/>
            </div>
        </div>
        <div class="group">
            <div class="label">
                <label>出生日期：</label>
            </div>
            <div class="field">
                <input type="date" class="mess" id="birthday" name="birthday"/>
            </div>
        </div>
        <div class="group">
            <div class="button">
                <button id="submit" type="button">提交</button>
            </div>
        </div>
    </form>
</div>
<div class="but">
    <button id="return" onclick="window.location.replace('community.html');">
        <img src="images/return.png">
    </button>
</div>
</body>
</html>